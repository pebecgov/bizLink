# Environment Variables Setup Guide

## Required Environment Variables

### Clerk Authentication Keys

You need the following keys from your [Clerk Dashboard](https://dashboard.clerk.com):

1. **NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY**
   - Location: Clerk Dashboard → API Keys
   - Format: `pk_test_...` (development) or `pk_live_...` (production)
   - Used by: Next.js client-side code

2. **CLERK_SECRET_KEY**
   - Location: Clerk Dashboard → API Keys
   - Format: `sk_test_...` (development) or `sk_live_...` (production)
   - Used by: Next.js server-side code (API routes, server components)

3. **CLERK_ISSUER_URL** (Optional but recommended)
   - Format: `https://<your-clerk-domain>.clerk.accounts.dev`
   - Example: `https://your-app.clerk.accounts.dev`
   - Used by: Convex auth.config.js
   - **Note**: If not provided, it will be derived from your publishable key, but explicit is better

4. **WEBHOOK_SECRET**
   - Location: Clerk Dashboard → Webhooks → [Your Webhook] → Signing Secret
   - Format: `whsec_...`
   - Used by: `/api/webhooks/clerk` route to verify webhook requests

### Convex Backend Keys

You need the following from your [Convex Dashboard](https://dashboard.convex.dev):

1. **NEXT_PUBLIC_CONVEX_URL**
   - Location: Convex Dashboard → Settings → Deployment URL
   - Format: `https://<deployment-name>.convex.cloud`
   - Used by: Next.js client to connect to Convex

2. **CONVEX_DEPLOYMENT_KEY**
   - Location: Convex Dashboard → Settings → Deployment Keys
   - Format: Long alphanumeric string
   - Used by: `npx convex dev` and `npx convex deploy`
   - **Note**: This is automatically added to `.env.local` when you run `npx convex dev`

## Complete `.env.local` Example

Create a `.env.local` file in your project root:

```env
# ============================================
# Clerk Authentication
# ============================================
# Get these from: https://dashboard.clerk.com → API Keys
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
CLERK_SECRET_KEY=sk_test_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# Clerk Issuer URL (optional, but recommended)
# Format: https://<your-clerk-domain>.clerk.accounts.dev
# Find in Clerk Dashboard → API Keys → JWT Template
CLERK_ISSUER_URL=https://your-app.clerk.accounts.dev

# Clerk Webhook Secret
# Get from: Clerk Dashboard → Webhooks → [Your Webhook] → Signing Secret
WEBHOOK_SECRET=whsec_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# ============================================
# Convex Backend
# ============================================
# Get from: Convex Dashboard → Settings → Deployment URL
NEXT_PUBLIC_CONVEX_URL=https://your-deployment.convex.cloud

# This is auto-generated when you run `npx convex dev`
# But you can also get it from: Convex Dashboard → Settings → Deployment Keys
CONVEX_DEPLOYMENT_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

## Setup Steps

### 1. Get Clerk Keys

1. Go to [Clerk Dashboard](https://dashboard.clerk.com)
2. Create a new application (or select existing)
3. Navigate to **API Keys** section
4. Copy:
   - **Publishable Key** → `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY`
   - **Secret Key** → `CLERK_SECRET_KEY`
5. To find your issuer URL:
   - Go to **JWT Templates** in Clerk Dashboard
   - Create a template named "convex" (or use existing)
   - The issuer URL is shown in the template settings
   - Or it's typically: `https://<your-app-name>.clerk.accounts.dev`

### 2. Setup Clerk Webhook

1. In Clerk Dashboard, go to **Webhooks**
2. Click **Add Endpoint**
3. Set endpoint URL: `https://your-domain.com/api/webhooks/clerk`
   - For local development, use [ngrok](https://ngrok.com) or similar
4. Subscribe to events:
   - `user.created`
   - `user.updated`
5. Copy the **Signing Secret** → `WEBHOOK_SECRET`

### 3. Get Convex Keys

1. Go to [Convex Dashboard](https://dashboard.convex.dev)
2. Create a new project (or select existing)
3. Run in terminal:
   ```bash
   npx convex dev
   ```
4. This will:
   - Create/update `.env.local` with `CONVEX_DEPLOYMENT_KEY`
   - Generate `NEXT_PUBLIC_CONVEX_URL`
   - Generate Convex types in `convex/_generated/`

### 4. Configure Convex Auth

The `convex/auth.config.js` file needs your Clerk issuer URL. It will:
- Use `CLERK_ISSUER_URL` if set
- Otherwise derive it from `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY`

**Recommended**: Set `CLERK_ISSUER_URL` explicitly in `.env.local`

## Verification Checklist

After setting up all environment variables:

- [ ] `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY` is set (starts with `pk_test_` or `pk_live_`)
- [ ] `CLERK_SECRET_KEY` is set (starts with `sk_test_` or `sk_live_`)
- [ ] `CLERK_ISSUER_URL` is set (or can be derived from publishable key)
- [ ] `WEBHOOK_SECRET` is set (starts with `whsec_`)
- [ ] `NEXT_PUBLIC_CONVEX_URL` is set (starts with `https://`)
- [ ] `CONVEX_DEPLOYMENT_KEY` is set (auto-generated by `npx convex dev`)
- [ ] Run `npx convex dev` to generate types
- [ ] Test authentication flow in the app

## Troubleshooting

### "Unauthenticated: No user identity found"

This usually means:
1. **Convex auth.config.js is misconfigured**
   - Check that `CLERK_ISSUER_URL` matches your Clerk domain
   - Verify the issuer URL format: `https://<domain>.clerk.accounts.dev`

2. **Token not being passed to Convex**
   - Check `app/providers.tsx` - should use `useAuth().getToken()`
   - Verify Clerk JWT template named "convex" exists

3. **Race condition on page load**
   - Use `<Authenticated>` component (already implemented)
   - Or handle `null` return from queries (already implemented)

### "Module not found: Can't resolve '@/convex/_generated/api'"

Run:
```bash
npx convex dev
```

This generates the required type files.

### Webhook not working

1. Verify `WEBHOOK_SECRET` matches Clerk Dashboard
2. Check webhook endpoint is accessible (use ngrok for local dev)
3. Verify webhook events are subscribed: `user.created`, `user.updated`

