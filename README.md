# BIZLNK Platform

PEBEC Business Directory - Module 0 & 1: Foundation, Security & Identity

## Overview

This module establishes the infrastructure-grade foundation for the PEBEC Business Directory (P-BD) platform. It focuses on the "Single Source of Truth" architecture, global security rules, and the mapping of external identity to internal roles.

## Technical Stack

- **Framework:** Next.js 14 (App Router)
- **Database/Backend:** Convex (Single source of truth for business state)
- **Authentication:** Clerk (Identity management)
- **Infrastructure:** Infrastructure-grade, non-demo setup

## Core Features

### 1. Global RBAC & Security
- **RBAC Layer:** Centralized utility in Convex to enforce role-based access control
- **Jurisdiction Scoping:** Permissions support scoping by jurisdiction (e.g., country-specific regulators)
- **Anti-Escalation:** Explicitly blocks and logs any attempts at unauthorized role escalation

### 2. Audit & Observability
- **Audit Log Table:** Central `audit_logs` table in Convex
- **Audit Helper:** `emitAuditLog` helper function
- **Mandate:** Every critical action and state transition **must** emit an audit event. If it is not logged, it did not happen.

### 3. Identity Mapping
- **User Schema:** Convex schema for users mapped to Clerk IDs
- **Registration Flow:** `ensureUserExists` mutation that triggers upon first Clerk login to sync the user into Convex
- **Role Assignment:** Controlled flow for assigning roles (Admin, Business, Regulator)

## Setup Instructions

1. **Install Dependencies**
   ```bash
   npm install
   ```

2. **Configure Environment Variables**
   
   **See [ENV_SETUP.md](./ENV_SETUP.md) for detailed instructions.**
   
   Create a `.env.local` file with the following keys:
   ```env
   # Clerk Authentication (from Clerk Dashboard → API Keys)
   NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_...
   CLERK_SECRET_KEY=sk_test_...
   CLERK_ISSUER_URL=https://your-app.clerk.accounts.dev
   WEBHOOK_SECRET=whsec_...

   # Convex Backend (auto-generated by `npx convex dev`)
   NEXT_PUBLIC_CONVEX_URL=https://your-deployment.convex.cloud
   CONVEX_DEPLOYMENT_KEY=...
   ```
   
   **Important**: You must create a JWT template named "convex" in Clerk Dashboard:
   - Go to Clerk Dashboard → JWT Templates
   - Create new template named "convex"
   - Copy the issuer URL to `CLERK_ISSUER_URL` in `.env.local`

3. **Initialize Convex**
   ```bash
   npx convex dev
   ```

4. **Setup Clerk Webhook**
   - Go to Clerk Dashboard → Webhooks
   - Add endpoint: `https://your-domain.com/api/webhooks/clerk`
   - Subscribe to events: `user.created`, `user.updated`
   - Copy the webhook secret to `.env.local` as `WEBHOOK_SECRET`

5. **Run Development Server**
   ```bash
   npm run dev
   ```

## Project Structure

```
project/
├── app/                    # Next.js App Router
│   ├── api/               # API routes
│   │   ├── webhooks/      # Clerk webhook handler
│   │   └── sync-user/     # User sync endpoint
│   ├── sign-in/           # Sign-in page
│   ├── sign-up/           # Sign-up page
│   ├── layout.tsx         # Root layout with providers
│   └── page.tsx           # Home page
├── convex/                # Convex backend
│   ├── schema.ts          # Database schema
│   ├── accessControl.ts   # RBAC utilities
│   ├── audit.ts           # Audit logging helper
│   ├── users.ts           # User mutations/queries
│   └── auth.config.js     # Convex auth config
├── lib/                   # Client utilities
│   └── convex-client.ts   # Convex React client
├── proxy.ts              # Clerk middleware (protects routes)
└── package.json
```

## Key Files

### `convex/schema.ts`
Defines the database schema with:
- `users` table: Maps Clerk IDs to internal roles
- `audit_logs` table: Central audit trail

### `convex/accessControl.ts`
RBAC utilities:
- `assertAuthenticatedUser`: Verifies user is authenticated
- `assertAuthorized`: Checks user has required role(s)
- `assertJurisdictionAccess`: Validates jurisdiction access for regulators

### `convex/audit.ts`
Global audit logging helper:
- `emitAuditLog`: Emits audit events for all critical actions

### `convex/users.ts`
User management:
- `ensureUserExists`: Syncs Clerk user to Convex
- `getCurrentUser`: Gets current authenticated user
- `updateUserRole`: Admin-only role assignment
- `updateUserStatus`: Admin-only status management

## Security Principles

1. **Single Source of Truth:** Convex manages all business state
2. **Identity & Auth:** Clerk handles identity; internal RBAC handles authorization
3. **Auditability:** If it is not logged, it did not happen
4. **Immutability:** Admin actions are reversible only via audit trails
5. **No Logic Leaks:** UI never mutates state directly; all mutations go through Convex with permission checks

## Definition of Done

✅ RBAC is enforced globally across all API endpoints  
✅ Audit logging system is fully operational and capturing login/role events  
✅ No direct state mutation can occur from the UI; all must pass through Convex mutations with permission checks  
✅ User registration flow syncs Clerk users to Convex automatically  
✅ All unauthorized access attempts are logged to audit_logs

## Next Steps

- Module 2: Business Verification
- Module 3: Partnership & Networking
- Module 4: Regulatory Facilitation
